on:
  push:
    branches: [ "feat/browser-embed" ]

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      deployments: write
    name: Publish to Cloudflare Pages
    steps:
      - name: checkout
        uses: actions/checkout@v3
      - name: get-wasm
        run: rustup target install wasm32-unknown-unknown
      - name: install-bindgen
        run: cargo install wasm-bindgen-cli
      - name: build
        run: cargo build --release --target wasm32-unknown-unknown
      - name: prepare-dir
        run: mkdir -p ./out/assets/ && cp ./public/index.html ./out/
      - name: package
        run: wasm-bindgen --out-dir ./out/ --no-typescript --target web ./target/wasm32-unknown-unknown/release/browser-sph.wasm        
      - name: publish-pages
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CF_API_TOKEN }}
          accountId: ${CF_ACCOUNT_ID}
          projectName: browser-sph
          directory: ./out/
